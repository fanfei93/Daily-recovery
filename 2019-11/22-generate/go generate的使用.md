## go generate 介绍

### 介绍

`go generate`命令是go 1.4版本里面新添加的一个命令，当运行`go generate`时，它将扫描与当前包相关的源代码文件，找出所有包含`//go:generate`的特殊注释，提取并执行该特殊注释后面的命令，命令为可执行程序，形同shell下面执行。

有几点需要注意：

+ 该特殊注释必须在`.go`源码文件中。
+ 每个源码文件可以包含多个`generate`特殊注释。
+ 显示运行`go generate`命令时，才会执行特殊注释后面的命令。
+ 命令串行执行的，如果出错，就终止后面的执行。
+ 特殊注释必须以`//go:generate`开头，双斜线后面没有空格。

### 应用

`go generate`的应用场景主要有以下几点：

+ yacc：从 .y 文件生成 .go 文件。
+ protobufs：从 protocol buffer 定义文件（.proto）生成 .pb.go 文件。
+ Unicode：从 UnicodeData.txt 生成 Unicode 表。
+ HTML：将 HTML 文件嵌入到 go 源码 。
+ bindata：将形如 JPEG 这样的文件转成 go 代码中的字节数组。
+ 为既定的泛型包生成特定的实现，比如用于ints的sort.Ints。

本文主要介绍`go generate`的另外一个作用，string方法，为类似枚举常量这样的类型生成`String()`方法。

### 示例

假设我们在`code.go`有一些代码，里面包含若干定义为`Pill`的整型常量：

```go
package generate

type Pill int

const (
	Placebo Pill = iota
	Aspirin
	Ibuprofen
	Paracetamol
)
```

为了调试的需要，我们需要为这些常量定义`String()`方法：

```go
func (p Pill) String() string {
    switch p {
    case Placebo:
        return "Placebo"
    case Aspirin:
        return "Aspirin"
    case Ibuprofen:
        return "Ibuprofen"
    case Paracetamol:
        return "Paracetamol"
    }
    return fmt.Sprintf("Pill(%d)", p)
}
```

这里，我们可以用`go generate`来实现`String()`，我们在`code.go`文件的头部加入这样一行代码：

```go
//go:generate stringer -type=Pill
package generate

type Pill int

const (
	Placebo Pill = iota
	Aspirin
	Ibuprofen
	Paracetamol
	Acetaminophen
)
```

在文件的开头包含了一个`//go:generate stringer -type=Pill`特殊注释，其中`stringer`是个生成`String`方法的工具，为了使用stringer方法，**在运行"go generate"命令前，我们需要安装stringer工具**，命令如下：

```shell
go get golang.org/x/tools/cmd/stringer
```

然后我们在`code.go`所在目录运行`go generate code.go`命令，运行完成后会在该目录下生成一个`pill_string.go`的文件，里面实现了我们需要的`String()`方法。我们来看一下这个文件的代码：

```go
// Code generated by "stringer -type=Pill"; DO NOT EDIT.

package generate

import "strconv"

func _() {
	// An "invalid array index" compiler error signifies that the constant values have changed.
	// Re-run the stringer command to generate them again.
	var x [1]struct{}
	_ = x[Placebo-0]
	_ = x[Aspirin-1]
	_ = x[Ibuprofen-2]
	_ = x[Paracetamol-3]
}

const _Pill_name = "PlaceboAspirinIbuprofenParacetamol"

var _Pill_index = [...]uint8{0, 7, 14, 23, 34}

func (i Pill) String() string {
	if i < 0 || i >= Pill(len(_Pill_index)-1) {
		return "Pill(" + strconv.FormatInt(int64(i), 10) + ")"
	}
	return _Pill_name[_Pill_index[i]:_Pill_index[i+1]]
}
```

定义常量`_Pill_name`用来保存所有`Pill`类型常量string拼接成的字符串，定义数组类全局变量`_Pill_index`，用来保存每个常量在`_Pill_name`中的下标，最后就是实现了我们的`String()方法`。

需要注意的是，`code.go`中的变量不能有相同的值，在值相同的情况下，只会返回前者的`string`，当`code.go`中的值改变时，运行或编译时会发生错误：`invalid array index`，这个时候需要重新运行`go generate`命令。

### 参考

[go generate的介绍](https://www.jianshu.com/p/a866147021da)